#!/usr/bin/env node

/**
 * Setup Script for Contact Form System
 * 
 * This interactive script helps you configure the environment variables
 * needed for the contact form and resend email system.
 * 
 * Usage:
 *   node setup-contact-form.js
 */

const readline = require('readline');
const fs = require('fs');
const path = require('path');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
});

function question(query) {
  return new Promise((resolve) => rl.question(query, resolve));
}

async function main() {
  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘  Contact Form & Resend Email System - Setup Wizard          â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  console.log('This wizard will help you configure your environment variables.\n');
  console.log('Press Enter to skip optional fields.\n');

  const config = {};

  // Google Sheets Configuration
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ“Š Google Sheets Configuration');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  const useJson = await question('Do you have a service account JSON file? (y/n): ');
  
  if (useJson.toLowerCase() === 'y') {
    const jsonPath = await question('Enter path to service account JSON file: ');
    try {
      const jsonContent = fs.readFileSync(jsonPath.trim(), 'utf8');
      // Minify JSON (remove whitespace)
      config.GOOGLE_SHEETS_CREDENTIALS = JSON.stringify(JSON.parse(jsonContent));
      console.log('âœ… Service account JSON loaded successfully\n');
    } catch (error) {
      console.error('âŒ Error reading JSON file:', error.message);
      console.log('You can add it manually to .env.local later.\n');
    }
  } else {
    console.log('\nYou can use individual credentials instead:');
    config.GOOGLE_CLIENT_EMAIL = await question('Google service account email: ');
    const privateKey = await question('Google private key (with \\n for newlines): ');
    if (privateKey) {
      config.GOOGLE_PRIVATE_KEY = `"${privateKey}"`;
    }
  }

  config.GOOGLE_SHEETS_ID = await question('\nGoogle Sheets ID (from spreadsheet URL): ');
  const sheetName = await question('Sheet name (default: ContactForm): ');
  config.GOOGLE_SHEETS_NAME = sheetName || 'ContactForm';

  // Resend Configuration
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ“§ Resend Email Configuration');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  config.RESEND_API_KEY = await question('Resend API key (starts with re_): ');
  config.RESEND_FROM_EMAIL = await question('From email address (verified domain): ');

  // Security Token
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ”’ Security Configuration');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  const generateToken = await question('Generate secure token for resend endpoint? (y/n): ');
  
  if (generateToken.toLowerCase() === 'y') {
    const crypto = require('crypto');
    config.RESEND_ROUTINE_TOKEN = crypto.randomBytes(32).toString('base64');
    console.log('âœ… Secure token generated\n');
  }

  // Site Configuration
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸŒ Site Configuration (Optional)');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  const siteUrl = await question('Site URL (default: https://micro-learning.app): ');
  if (siteUrl) config.NEXT_PUBLIC_SITE_URL = siteUrl;

  const siteName = await question('Site name (default: Microlearning): ');
  if (siteName) config.NEXT_PUBLIC_SITE_NAME = siteName;

  // Generate .env.local content
  console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ“ Generating Configuration');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  let envContent = '# Auto-generated by setup script\n';
  envContent += `# Generated on ${new Date().toISOString()}\n\n`;

  // Add contact form configuration
  envContent += '# Contact Form & Email Configuration\n';
  for (const [key, value] of Object.entries(config)) {
    if (value) {
      envContent += `${key}=${value}\n`;
    }
  }

  // Check if .env.local exists
  const envPath = path.join(process.cwd(), '.env.local');
  const envExists = fs.existsSync(envPath);

  if (envExists) {
    console.log('âš ï¸  .env.local already exists!\n');
    const overwrite = await question('Overwrite existing .env.local? (y/n): ');
    
    if (overwrite.toLowerCase() !== 'y') {
      console.log('\nðŸ“„ Configuration not saved. Here\'s what would be written:\n');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log(envContent);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
      console.log('You can copy this to .env.local manually.\n');
      rl.close();
      return;
    }
  }

  // Write to .env.local
  try {
    fs.writeFileSync(envPath, envContent, 'utf8');
    console.log('\nâœ… Configuration saved to .env.local\n');
  } catch (error) {
    console.error('âŒ Error writing .env.local:', error.message);
    console.log('\nHere\'s the configuration to add manually:\n');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log(envContent);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
  }

  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸŽ‰ Setup Complete!');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  console.log('Next steps:');
  console.log('  1. Start development server: npm run dev');
  console.log('  2. Test contact form at: http://localhost:3000/#contact');
  console.log('  3. Check Google Sheet for new entries');
  console.log('  4. Set up cron job for automated resends');
  console.log('\nFor detailed instructions, see: CONTACT_FORM_SETUP.md\n');

  rl.close();
}

main().catch((error) => {
  console.error('Error:', error);
  rl.close();
  process.exit(1);
});
